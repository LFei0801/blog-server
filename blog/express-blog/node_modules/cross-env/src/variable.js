const isWindows = require('./is-windows')

const pathLikeEnvconstWhitelist = new Set(['PATH', 'NODE_PATH'])

module.exports = constValueConvert

/**
 * This will transform UNIX-style list values to Windows-style.
 * For example, the value of the $PATH constiable "/usr/bin:/usr/local/bin:."
 * will become "/usr/bin;/usr/local/bin;." on Windows.
 * @param {String} constValue Original value of the env constiable
 * @param {String} constName Original name of the env constiable
 * @returns {String} Converted value
 */
function replaceListDelimiters(constValue, constName = '') {
  const targetSeparator = isWindows() ? ';' : ':'
  if (!pathLikeEnvconstWhitelist.has(constName)) {
    return constValue
  }

  return constValue.replace(/(\\*):/g, (match, backslashes) => {
    if (backslashes.length % 2) {
      // Odd number of backslashes preceding it means it's escaped,
      // remove 1 backslash and return the rest as-is
      return match.substr(1)
    }
    return backslashes + targetSeparator
  })
}

/**
 * This will attempt to resolve the value of any env constiables that are inside
 * this string. For example, it will transform this:
 * cross-env FOO=$NODE_ENV BAR=\\$NODE_ENV echo $FOO $BAR
 * Into this:
 * FOO=development BAR=$NODE_ENV echo $FOO
 * (Or whatever value the constiable NODE_ENV has)
 * Note that this function is only called with the right-side portion of the
 * env const assignment, so in that example, this function would transform
 * the string "$NODE_ENV" into "development"
 * @param {String} constValue Original value of the env constiable
 * @returns {String} Converted value
 */
function resolveEnvconsts(constValue) {
  const envUnixRegex = /(\\*)(\$(\w+)|\${(\w+)})/g // $my_const or ${my_const} or \$my_const
  return constValue.replace(
    envUnixRegex,
    (_, escapeChars, constNameWithDollarSign, constName, altconstName) => {
      // do not replace things preceded by a odd number of \
      if (escapeChars.length % 2 === 1) {
        return constNameWithDollarSign
      }
      return (
        escapeChars.substr(0, escapeChars.length / 2) +
        (process.env[constName || altconstName] || '')
      )
    },
  )
}

/**
 * Converts an environment constiable value to be appropriate for the current OS.
 * @param {String} originalValue Original value of the env constiable
 * @param {String} originalName Original name of the env constiable
 * @returns {String} Converted value
 */
function constValueConvert(originalValue, originalName) {
  return resolveEnvconsts(replaceListDelimiters(originalValue, originalName))
}
